package com.clt.jaxrs.sar;

import java.text.DateFormatSymbols;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import javax.annotation.security.RolesAllowed;
import javax.ws.rs.Consumes;
import javax.ws.rs.DefaultValue;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;

import com.clt.apps.opus.stm.sar.servicesio.efinance.EfinanceAPISC;
import com.clt.apps.opus.stm.sar.servicesio.efinance.vo.RestDisputeStatisticVO;
import com.clt.apps.opus.stm.sar.servicesio.efinance.vo.RestDisputeSummaryVO;
import com.clt.apps.opus.stm.sar.servicesio.efinance.vo.RestDisputeVO;
import com.clt.framework.core.layer.event.EventException;
import com.clt.syscommon.common.util.RestfulUtil;

/**
 * @since J2EE 1.6
 * @author CuongTran
 * @see 
 * 
 * 
 *
 */
@Path("/efinance/clear")
public class EfinanceClearRestProxy { 
	protected transient Logger log = Logger.getLogger(getClass().getName());
	private static final String efinanceErrMsg = "Unexpected system error took place during data processing. Please try again later..";
	
	/**
	 * getPing
	 * @return javax.ws.rs.core.Response
	 */
	@GET
	@Path("/ping")
	@Produces("text/plain") 
	public String getPing() { 
		return "Call EfinanceClearRestProxy GET ver. 2022-05-17";
	}
	
	/**
	 * Provide data of dispute invoice summary to visualize on Efinance dash-board chart
	 * @param String custCds
	 * @param String frmDt
	 * @param String toDt
	 * @param String dateType
	 * @return Response
	 */
	@RolesAllowed("EAI") 
	@GET 
	@Path("/dispute-summary")
	@Consumes(MediaType.APPLICATION_JSON) 
	@Produces(MediaType.TEXT_PLAIN)
	public Response getDisputeSummary( @DefaultValue("") @QueryParam("customerCode") String custCds,
									   @DefaultValue("") @QueryParam("fromDate") String frmDt,
									   @DefaultValue("") @QueryParam("toDate") String toDt,
									   @DefaultValue("") @QueryParam("summaryBy") String dateType){
		
		
		if(StringUtils.isEmpty(custCds)){
			return Response.status(Status.BAD_REQUEST).entity("There is missing 'customerCode'.").build();
		}
		if(StringUtils.isEmpty(frmDt) || StringUtils.isEmpty(toDt)){
			return Response.status(Status.BAD_REQUEST).entity("There is missing 'fromDate' or 'toDate'.").build();
		}
		if(StringUtils.isEmpty(dateType)){
			return Response.status(Status.BAD_REQUEST).entity("There is missing 'summaryBy'.").build();
		} else {
			if (!"disputeDate".equals(dateType) && !"issueDate".equals(dateType)){
				return Response.status(Status.BAD_REQUEST).entity("The 'summaryBy' must be 'disputeDate' or 'issueDate'.").build();
			}
		}
		EfinanceAPISC sc = new EfinanceAPISC(); 
		Map<String, Object> contents = new HashMap<String, Object>();
		List<RestDisputeSummaryVO> list = new ArrayList<RestDisputeSummaryVO>();
		RestDisputeVO restVo = new RestDisputeVO();
		int startMonth = 0;
		int endMonth = 11;
		try {
			Date fromDate = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss:SSS").parse(frmDt.trim()+" 00:00:00:000");
			Date toDate = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss:SSS").parse(toDt.trim()+" 23:59:59:999");
			Calendar cal1 = Calendar.getInstance();
			cal1.setTime(fromDate);
			Calendar cal2 = Calendar.getInstance();
			cal2.setTime(toDate);
			if(cal1.get(Calendar.YEAR) != cal2.get(Calendar.YEAR)){
				return Response.status(Status.BAD_REQUEST).entity("'fromDate' and 'toDate' must be within a year.").build();
			}
			if(fromDate.after(toDate)){
				return Response.status(Status.BAD_REQUEST).entity("The 'fromDate' must be less than 'toDate'.").build();
			}
			startMonth = cal1.get(Calendar.MONTH);
			endMonth = cal2.get(Calendar.MONTH);
			restVo.setCustCd(custCds);
			restVo.setFrmDt(frmDt);
			restVo.setToDt(toDt); 
			restVo.setDateType(dateType);
			list = sc.searchDisputeSummary(restVo);
		} catch (ParseException e1) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).entity(getErrorMessage(e1.getMessage())).build();
		} catch (EventException e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).entity(getErrorMessage(e.getMessage())).build();
		}
		contents.put("items",makeResponseForSummary(list,startMonth,endMonth));
		return Response.status(Status.OK).entity(RestfulUtil.JsonFromCustomVo(contents)).build();
	}
	
	/**
	 * Provide data of recent invoice statistics to visualize on Efinance dash-board chart
	 * 
	 * @param String custCd
	 * @return Response
	 */
	@RolesAllowed("EAI") 
	@GET 
	@Path("/dispute-statistics")
	@Consumes(MediaType.APPLICATION_JSON) 
	@Produces(MediaType.TEXT_PLAIN)
	public Response getDisputeStatistic( @DefaultValue("") @QueryParam("customerCode") String custCd){
		if(StringUtils.isEmpty(custCd)){
			return Response.status(Status.BAD_REQUEST).entity("There is missing 'customerCode'.").build();
		}
		EfinanceAPISC sc = new EfinanceAPISC(); 
		Map<String, Object> contents = new HashMap<String, Object>();
		List<RestDisputeStatisticVO> list = new ArrayList<RestDisputeStatisticVO>();
		RestDisputeVO restVo = new RestDisputeVO();
		try {
			restVo.setCustCd(custCd);
			list = sc.searchDisputeStatistic(restVo);
		} catch (EventException e) {
			// TODO Auto-generated catch block
			return Response.status(Status.INTERNAL_SERVER_ERROR).entity(getErrorMessage(e.getMessage())).build();
		}
		contents = makeResponseForSatistics(list);
		return Response.status(Status.OK).entity(RestfulUtil.JsonFromCustomVo(contents)).build();
	}
	
	/**
	 * Make json data
	 * 
	 * @param List<RestDisputeStatisticVO> list
	 * @return Map<String, Object>
	 */
	private Map<String, Object> makeResponseForSatistics(List<RestDisputeStatisticVO> list){
		Map<String, Object> result = new HashMap<String, Object>();
		List<RestDisputeStatisticVO> listDisputeSatisticsVOs = new ArrayList<RestDisputeStatisticVO>();
		for (RestDisputeStatisticVO vo : list) {
			String invType = vo.getDisputeStatus();
			String totalInv = vo.getTotalInvoices();
			RestDisputeStatisticVO obj = checkDisputeSts(listDisputeSatisticsVOs, invType);
			if(obj != null){
				List<RestDisputeStatisticVO> subItems = obj.getAmounts();
				RestDisputeStatisticVO subItem = new RestDisputeStatisticVO();
				int firstInvTotal = Integer.valueOf(obj.getTotalInvoices());
				int secondInvTotal =  Integer.valueOf(totalInv) + firstInvTotal;
				obj.setTotalInvoices(String.valueOf(secondInvTotal));
				subItem.setCurrency(vo.getCurrency());
				subItem.setAmount(vo.getAmount());
				subItems.add(subItem);
			} else {
				List<RestDisputeStatisticVO> subItems = new ArrayList<RestDisputeStatisticVO>();
				RestDisputeStatisticVO mainItem = new RestDisputeStatisticVO();
				RestDisputeStatisticVO subItem = new RestDisputeStatisticVO();
				// Main
				mainItem.setDisputeStatus(invType);
				mainItem.setTotalInvoices(totalInv);
				// Sub
				subItem.setCurrency(vo.getCurrency());
				subItem.setAmount(vo.getAmount());
				subItems.add(subItem);
				// Add to result
				mainItem.setAmounts(subItems);
				listDisputeSatisticsVOs.add(mainItem);
			}
			
		}
		result.put("items", listDisputeSatisticsVOs);
		return result;
	}
	
	/**
	 * check item exists in List
	 * 
	 * @param List<RestDisputeStatisticVO> list
	 * @param String status
	 * @return RestDisputeStatisticVO
	 */
	private RestDisputeStatisticVO checkDisputeSts(List<RestDisputeStatisticVO> list, String status){
		for (RestDisputeStatisticVO vo : list) {
			if(status.equals(vo.getDisputeStatus())){
				return vo;
			}
		}
		return null;
	}
	
	/**
	 * Create empty data for the month don't have data
	 * 
	 * @param List<RestDisputeSummaryVO> list
	 * @param int startMonth
	 * @param int endMonth
	 * @return List<RestDisputeSummaryVO>
	 */
	private List<RestDisputeSummaryVO> makeResponseForSummary(List<RestDisputeSummaryVO> list, int startMonth, int endMonth) {
		String[] array = new DateFormatSymbols(Locale.US).getMonths();
		List<String> months = new ArrayList<String>();
		List<String> monthInVo = new ArrayList<String>();
		List<RestDisputeSummaryVO> result = new ArrayList<RestDisputeSummaryVO>();
		// check empty in array
		for (String item : array) {
			if(!StringUtils.isEmpty(item)){
				months.add(item.substring(0,3));
			}
		}
		// add month from VOs to list
		for (RestDisputeSummaryVO vo : list) {
			monthInVo.add(vo.getDisplayMonth());
		}
		
		// check data exist
		for (String month : months) {
			int indexMonth = months.indexOf(month);
			if(indexMonth < startMonth || indexMonth > endMonth) continue;
			if(!monthInVo.contains(month)){
				RestDisputeSummaryVO addNew = new RestDisputeSummaryVO(month,"0","0","0");
				result.add(addNew);
			} else {
				RestDisputeSummaryVO data =  list.get(monthInVo.indexOf(month));
				if(month.equals(data.getDisplayMonth())){
					result.add(data);
				}
			}
		}
		return result;
	}
	/**
	 * Get error message in message of EventException
	 * 
	 * @param String msg
	 * @return String
	 */
	private String getErrorMessage(String msg){
		if(StringUtils.isEmpty(msg)) return efinanceErrMsg;
		String[] errMsgs =  msg.split("<\\|\\|>");
		String result = efinanceErrMsg;
		if(!StringUtils.isEmpty(errMsgs[0])){
			result = errMsgs[0];
		}
		return result;
	}
}